# C++ 接口实现方法

## 函数签名

一个处理业务接口的函数签名大约如下：

```cpp
EINT on_action_name(const json& jReq, json& jRet);
```

其中 `EINT` 就是整数 `int` 的别号（`typedef`），专门用以表示函数将返回错误码，
`0` 表示成功，没有错误错误，非 `0` 表示有错误。这是为了区分有些函数可能返回普
通 `int` 的计量整数。须特别注意这与 `bool` 类型是相反直觉的，`0` 在 `bool` 语
境下是 `false` 。

两个参数，`const` 的是入参，非 `const` 的是出参。基本对应请求与响应的 json 数
据。这须要用到一个 json 库来处理 json 数据类型，当前服务选用的是开源库：
https://github.com/nlohmann/json 。

## 入参 jReq

入参格式请参考 [接口模式概述](../ch2_japi/post_json.md) 。解析成功并检查必要参
数及其类型后才传给接口处理函数。可能会对 `session` 对象内字段作些预处理，但不
会修改 `data` 对象内的数据。一般业务接口只需根据 `data` 内的参数进行逻辑处理。

## 出参 jRet

对出参的约定，有两种模式。

* 完整模式：构建完整的响应内容，主要是内嵌的 `data` 对象。
* 精简模式：只构建 `data` 主体内容。

当接口函数返回后，框架根据 `jRet` 是否已经内嵌有 `data` 来判断是完整模式还是精
简模式。如果是精简模式，会对最终返回的 json 格式作修整，以符合接口设计规范。大
约进行如下修整：

```cpp
jRet["data"] = jRet;
```

因为大多业务接口只要写入 `jRet["data"]` 对象，所以为了方便起见，框架设计接口时
支持精简模式。但为灵活起见，若某个接口需要定制额外数据，可用完整模式。

此外，框架设计中也会固定原路返回一些请求参数如 `to` `action` 等，所以即使想使
用完整模式，也没必要自己再填这些参数。在下层接口处理函数中，也没法抑制原路返回
这些参数。

## 返回值与错误码

接口处理函数返回的错误码，不妨设为 `error` ，会被自动填入返回 json 的相应字段
，同时在非零的情况下根据错误码值填入错误消息。形如：

```cpp
jRet["error"] = error;
jRet["errstr"] = GetErrorMsg(error);
```

如果预定义的错误码不足或觉得错误消息不够准确，可以在接口处理函数中手动添加
`errstr` 字段，以代替自动查找错误消息的机制，形如：

```cpp
jRet["errstr"] = "自定义错误消息";    // 若将 jRet 当作完整模式处理
jRet["../errstr"] = "自定义错误消息"; // 若将 jRet 当作精简模式处理
```

该错误消息一般是由客户端接收后向用户呈现，宜考虑用户理解友好度。

在接口处理函数中也可以手动填写 `jRet["error"]` 或 `jRet["../error"]` ，如此也
比函数返回值的错误码优先级高，自动查找错误消息时也以此为准。但一般不建议手动设
`error` 字段，只在必要时定制 `errstr` 字段。

如果发现需要频繁定制某条错误消息，则建议新定义一个错误码及其关联的错误消息。如
此可只用函数返回值简化错误码与消息的传递。
